name: Python CI/CD Pipeline
on: [push, pull_request]

permissions:
  contents: read
  checks: write
  statuses: write

jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Super-Linter
        uses: github/super-linter@v5
        env:
          VALIDATE_ALL_CODEBASE: true
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
      - name: Pylint Quality Check
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install pylint
          pylint --fail-under=7.0 ${{ steps.check-py-files.outputs.files }}
        continue-on-error: true

  test:
    name: Run Tests
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Set up OS dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            x11-utils \
            libopengl0 \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-qt PyQt5
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -e .[dev]

      - name: Run tests
        run: |
          export QT_DEBUG_PLUGINS=1
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 3
          pytest tests/ -v
